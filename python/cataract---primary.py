# Kuan V, Denaxas S, Gonzalez-Izquierdo A, Direk K, Bhatti O, Husain S, Sutaria S, Hingorani M, Nitsch D, Parisinos C, Lumbers T, Mathur R, Sofat R, Casas JP, Wong I, Hemingway H, Hingorani A, 2023.

import sys, csv, re

codes = [{"code":"1483","system":"readv2"},{"code":"2BT..00","system":"readv2"},{"code":"7263011","system":"readv2"},{"code":"7266100","system":"readv2"},{"code":"8LC0.00","system":"readv2"},{"code":"F46..00","system":"readv2"},{"code":"F461200","system":"readv2"},{"code":"F461300","system":"readv2"},{"code":"F461400","system":"readv2"},{"code":"F461B00","system":"readv2"},{"code":"F461B11","system":"readv2"},{"code":"F463200","system":"readv2"},{"code":"F463300","system":"readv2"},{"code":"F463400","system":"readv2"},{"code":"F464100","system":"readv2"},{"code":"F464200","system":"readv2"},{"code":"F465.00","system":"readv2"},{"code":"F465z00","system":"readv2"},{"code":"F46z.00","system":"readv2"},{"code":"P33y000","system":"readv2"},{"code":"10010","system":"med"},{"code":"100770","system":"med"},{"code":"101939","system":"med"},{"code":"103508","system":"med"},{"code":"104553","system":"med"},{"code":"105971","system":"med"},{"code":"10659","system":"med"},{"code":"110400","system":"med"},{"code":"11255","system":"med"},{"code":"11767","system":"med"},{"code":"11941","system":"med"},{"code":"15589","system":"med"},{"code":"1622","system":"med"},{"code":"17545","system":"med"},{"code":"18048","system":"med"},{"code":"18089","system":"med"},{"code":"19371","system":"med"},{"code":"22022","system":"med"},{"code":"23631","system":"med"},{"code":"23883","system":"med"},{"code":"24467","system":"med"},{"code":"26097","system":"med"},{"code":"26850","system":"med"},{"code":"27898","system":"med"},{"code":"296","system":"med"},{"code":"29770","system":"med"},{"code":"299","system":"med"},{"code":"33482","system":"med"},{"code":"33793","system":"med"},{"code":"38641","system":"med"},{"code":"39081","system":"med"},{"code":"4148","system":"med"},{"code":"41668","system":"med"},{"code":"4242","system":"med"},{"code":"42452","system":"med"},{"code":"4260","system":"med"},{"code":"4358","system":"med"},{"code":"44260","system":"med"},{"code":"44294","system":"med"},{"code":"44487","system":"med"},{"code":"4459","system":"med"},{"code":"44779","system":"med"},{"code":"44794","system":"med"},{"code":"44982","system":"med"},{"code":"45190","system":"med"},{"code":"45926","system":"med"},{"code":"45952","system":"med"},{"code":"46169","system":"med"},{"code":"47566","system":"med"},{"code":"48148","system":"med"},{"code":"48192","system":"med"},{"code":"48228","system":"med"},{"code":"49085","system":"med"},{"code":"49297","system":"med"},{"code":"49554","system":"med"},{"code":"50932","system":"med"},{"code":"51162","system":"med"},{"code":"5325","system":"med"},{"code":"5361","system":"med"},{"code":"54130","system":"med"},{"code":"57805","system":"med"},{"code":"58078","system":"med"},{"code":"58625","system":"med"},{"code":"59125","system":"med"},{"code":"59914","system":"med"},{"code":"60425","system":"med"},{"code":"60883","system":"med"},{"code":"61325","system":"med"},{"code":"62188","system":"med"},{"code":"6317","system":"med"},{"code":"63212","system":"med"},{"code":"6330","system":"med"},{"code":"63429","system":"med"},{"code":"63491","system":"med"},{"code":"63640","system":"med"},{"code":"64196","system":"med"},{"code":"6547","system":"med"},{"code":"6876","system":"med"},{"code":"69278","system":"med"},{"code":"70201","system":"med"},{"code":"70257","system":"med"},{"code":"703","system":"med"},{"code":"70403","system":"med"},{"code":"70700","system":"med"},{"code":"71291","system":"med"},{"code":"71623","system":"med"},{"code":"7257","system":"med"},{"code":"7793","system":"med"},{"code":"8130","system":"med"},{"code":"88738","system":"med"},{"code":"89585","system":"med"},{"code":"90279","system":"med"},{"code":"92358","system":"med"},{"code":"93727","system":"med"},{"code":"94348","system":"med"},{"code":"94430","system":"med"},{"code":"94474","system":"med"},{"code":"96385","system":"med"},{"code":"98962","system":"med"},{"code":"9931","system":"med"},{"code":"99424","system":"med"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('cataract-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["cataract---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["cataract---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["cataract---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
